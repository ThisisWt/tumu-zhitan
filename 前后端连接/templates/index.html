<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>结构模型与DXF文件处理</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
        <style>
        body {
            text-align: center;
            background-image: url("background.png");
            background-size: cover;
            /* 设置背景满铺 */
            background-attachment: fixed;
        }

        .white {
            color: white;
        }
    </style>
</head>
<body>
    <h1>结构模型与DXF文件处理</h1>
    <form id="actionForm">
        <label for="dimensions">请输入尺寸（用逗号分隔）或操作DXF文件:</label><br>
        <input type="text" id="dimensions" name="dimensions"><br>
        <select name="action" id="action" onchange="toggleSphereInput()">
            <option value="矩形梁">矩形梁</option>
            <option value="圆柱体">圆柱体</option>
            <option value="球体">球体</option>
            <option value="导入DXF">导入DXF</option>
            <option value="分析DXF">分析DXF</option>
            <option value="修改DXF">修改DXF</option>
            <option value="可视化DXF">可视化DXF</option>
            <option value="导出DXF">导出DXF</option>
        </select><br>
        <button type="button" onclick="executeAction()">执行操作</button>
    </form>
    <div id="result"></div>

    <!-- 三维模型容器 -->
    <div id="3dModelContainer" style="display: none;">
        <div id="modelModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <canvas id="3dCanvas" width="500" height="500"></canvas>
                <p id="modelDimensions" style="position: absolute; top: 10px; left: 10px; color: white; font-weight: bold;"></p>
                <button onclick="saveModel()">保存模型</button>
                <button onclick="rebuildModel()">删除重建</button>
            </div>
        </div>
    </div>

    <script>
        var modal = document.getElementById("modelModal");

        function toggleSphereInput() {
            var action = document.getElementById('action').value;
            var sphereInput = document.getElementById('sphereInput');
            if (action === '球体') {
                sphereInput.style.display = 'block';
            } else {
                sphereInput.style.display = 'none';
            }
        }

        function executeAction() {
            var action = document.getElementById('action').value;
            var dimensions = document.getElementById('dimensions').value;
            axios.post('/', {
                action: action,
                dimensions: dimensions.split(',')
            }, {
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(function (response) {
                var result = response.data.result;
                var error = response.data.error;
                if (result) {
                    document.getElementById('result').innerHTML = result;
                    // 根据操作类型显示对应的三维模型
                    if (action === '矩形梁' || action === '圆柱体' || action === '球体') {
                        document.getElementById('3dModelContainer').style.display = 'block';
                        openModal();
                        draw3DModel(action, dimensions);
                    } else {
                        document.getElementById('3dModelContainer').style.display = 'none';
                    }
                } else if (error) {
                    console.error(error);
                } else {
                    console.error('Unknown error occurred.');
                }
            })
            .catch(function (error) {
                console.error(error);
            });
        }

        function openModal() {
            modal.style.display = "block";
        }

        function closeModal() {
            modal.style.display = "none";
        }

        function saveModel() {
            var canvas = document.getElementById("3dCanvas");
            var link = document.createElement('a');
            link.download = 'model.png';
            link.href = canvas.toDataURL("image/png");
            link.click();
        }

        function rebuildModel() {
            closeModal();
            var action = document.getElementById('action').value;
            var dimensions = document.getElementById('dimensions').value;
            draw3DModel(action, dimensions);
        }

        // 绘制三维模型
        function draw3DModel(action, dimensions) {
            var canvas = document.getElementById('3dCanvas');
            var renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setClearColor(0x000000);

            // 创建一个场景
            var scene = new THREE.Scene();

            // 创建一个透视相机
            var camera = new THREE.PerspectiveCamera(75, canvas.width / canvas.height, 0.1, 1000);
            camera.position.z = 5;

            // 添加一个直角坐标系
            var axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);

            var geometry, material, mesh;

            // 添加一个立方体或圆柱体或球体到场景中
            if (action === '矩形梁') {
                var dimensionsArray = dimensions.split(',').map(Number);
                geometry = new THREE.BoxGeometry(dimensionsArray[0], dimensionsArray[1], dimensionsArray[2]);
                material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
                mesh = new THREE.Mesh(geometry, material);
                document.getElementById('modelDimensions').innerText = `尺寸：${dimensionsArray[0]} x ${dimensionsArray[1]} x ${dimensionsArray[2]}`;
                var sizeLabel = createSizeLabel(dimensionsArray);
                mesh.add(sizeLabel);
            } else if (action === '圆柱体') {
                var dimensionsArray = dimensions.split(',').map(Number);
                geometry = new THREE.CylinderGeometry(dimensionsArray[0], dimensionsArray[0], dimensionsArray[1], 32);
                material = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                mesh = new THREE.Mesh(geometry, material);
                document.getElementById('modelDimensions').innerText = `尺寸：底面半径 ${dimensionsArray[0]}，高度 ${dimensionsArray[1]}`;
                var sizeLabel = createSizeLabel(dimensionsArray);
                mesh.add(sizeLabel);
            } else if (action === '球体') {
                var radius = parseFloat(dimensions[0]);
                geometry = new THREE.SphereGeometry(radius, 32, 32);
                material = new THREE.MeshBasicMaterial({ color: 0x0000ff });
                mesh = new THREE.Mesh(geometry, material);
                document.getElementById('modelDimensions').innerText = `尺寸：半径 ${radius}`;
                var sizeLabel = createSizeLabel([radius]);
                mesh.add(sizeLabel);
            }

            scene.add(mesh);

            // 渲染场景
            function render() {
                requestAnimationFrame(render);
                mesh.rotation.x += 0.01;
                mesh.rotation.y += 0.01;
                renderer.render(scene, camera);
            }
            render();
        }

        // 创建尺寸标签
        function createSizeLabel(dimensions) {
            var sizeLabel = new THREE.Group();

            var text = createTextSprite(`X: ${dimensions[0]} mm`, 32, 'white');
            text.position.set(dimensions[0] / 2 + 0.5, 0, 0);
            sizeLabel.add(text);

            if (dimensions.length > 1) {
                text = createTextSprite(`Y: ${dimensions[1]} mm`, 32, 'white');
                text.position.set(0, dimensions[1] / 2 + 0.5, 0);
                sizeLabel.add(text);
            }

            if (dimensions.length > 2) {
                text = createTextSprite(`Z: ${dimensions[2]} mm`, 32, 'white');
                text.position.set(0, 0, dimensions[2] / 2 + 0.5);
                sizeLabel.add(text);
            }

            return sizeLabel;
        }

        // 创建文本精灵
        function createTextSprite(message, fontsize, color) {
            var canvas = document.createElement('canvas');
            var context = canvas.getContext('2d');
            context.font = `Bold ${fontsize}px Arial`;
            context.fillStyle = color;
            context.fillText(message, 0, fontsize);

            var texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;

            var spriteMaterial = new THREE.SpriteMaterial({ map: texture });
            var sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(1, 0.5, 0.1);

            return sprite;
        }
    </script>
     <img src="同济大学背景题头.png" style="width: 100%; object-position: center;">
</body>
</html>
